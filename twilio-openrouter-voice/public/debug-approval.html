<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Approval Buttons</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .debug-section {
            margin: 20px 0;
            padding: 20px;
            border: 2px solid #007bff;
            border-radius: 8px;
            background-color: #f8f9fa;
        }
        .approval-section {
            margin: 15px 0;
            padding: 15px;
            border: 1px solid #28a745;
            border-radius: 5px;
            background-color: #d4edda;
        }
        .draft-preview {
            background-color: #fff;
            padding: 10px;
            border-radius: 4px;
            margin: 10px 0;
            border-left: 4px solid #007bff;
        }
        .log-output {
            background-color: #000;
            color: #00ff00;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            height: 200px;
            overflow-y: auto;
            margin: 10px 0;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1>üîß Debug Approval Buttons</h1>
        <p>This page tests the approval button functionality in isolation.</p>

        <div class="debug-section">
            <h3>üìÖ Calendar Event Test</h3>
            <div class="approval-section">
                <h4>üìÖ Calendar Event Requires Approval</h4>
                <div class="draft-preview">
                    Title: Test Dentist Appointment<br>
                    Start: 8/8/2025, 2:00:00 PM<br>
                    End: 8/8/2025, 3:00:00 PM<br>
                    Attendees: None
                </div>
                <button class="btn btn-success approval-btn" 
                        data-result-id="debug-test-123" 
                        data-action-type="calendar" 
                        data-action="approve">
                    Approve & Create
                </button>
                <button class="btn btn-secondary approval-btn" 
                        data-result-id="debug-test-123" 
                        data-action="reject">
                    Reject
                </button>
            </div>
        </div>

        <div class="debug-section">
            <h3>üìß Email Test</h3>
            <div class="approval-section">
                <h4>üìß Email Draft Requires Approval</h4>
                <div class="draft-preview">
                    To: john@example.com<br>
                    Subject: Re: Meeting Request<br>
                    Body: I can meet tomorrow at 2 PM. Let me know if that works for you.
                </div>
                <button class="btn btn-success approval-btn" 
                        data-result-id="debug-email-456" 
                        data-action-type="email" 
                        data-action="approve">
                    Approve & Send
                </button>
                <button class="btn btn-secondary approval-btn" 
                        data-result-id="debug-email-456" 
                        data-action="reject">
                    Reject
                </button>
            </div>
        </div>

        <div class="debug-section">
            <h3>üîç Debug Log</h3>
            <div class="log-output" id="debugLog">
                Debug log will appear here...<br>
            </div>
            <button class="btn btn-warning" onclick="clearLog()">Clear Log</button>
        </div>

        <div class="debug-section">
            <h3>üß™ Manual Test</h3>
            <button class="btn btn-primary" onclick="testApprovalAPI()">Test Approval API Directly</button>
            <button class="btn btn-info" onclick="createCalendarEvent()">Create Calendar Event</button>
        </div>
    </div>

    <script>
        // Debug logging
        function log(message) {
            const logElement = document.getElementById('debugLog');
            const timestamp = new Date().toLocaleTimeString();
            logElement.innerHTML += `[${timestamp}] ${message}<br>`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }

        function clearLog() {
            document.getElementById('debugLog').innerHTML = 'Debug log cleared...<br>';
        }

        // Initialize logging
        log('üöÄ Debug page loaded');

        // Event delegation for approval buttons
        document.addEventListener('click', (e) => {
            log(`Click detected on: ${e.target.tagName} with classes: ${e.target.classList.toString()}`);
            
            // Check if clicked element or any parent has approval-btn class
            let targetElement = e.target;
            let foundApprovalBtn = false;
            
            // Walk up the DOM tree to find approval button
            while (targetElement && targetElement !== document) {
                if (targetElement.classList && targetElement.classList.contains('approval-btn')) {
                    foundApprovalBtn = true;
                    break;
                }
                targetElement = targetElement.parentElement;
            }
            
            if (foundApprovalBtn) {
                log(`üü¢ Approval button found: ${targetElement.textContent.trim()}`);
                
                const resultId = targetElement.dataset.resultId;
                const actionType = targetElement.dataset.actionType;
                const action = targetElement.dataset.action;
                
                log(`üü¢ Button data: resultId=${resultId}, actionType=${actionType}, action=${action}`);
                
                if (action === 'approve') {
                    approveAction(resultId, actionType);
                } else if (action === 'reject') {
                    rejectAction(resultId);
                }
            }
        });

        // Approval functions
        async function approveAction(resultId, actionType) {
            try {
                log(`üü¢ APPROVE ACTION CALLED: ${resultId}, ${actionType}`);
                
                const requestBody = {
                    resultId,
                    actionType,
                    approved: true
                };
                
                log(`üü¢ Sending request: ${JSON.stringify(requestBody)}`);
                
                const response = await fetch('/api/test-comprehensive/approve', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                log(`üü¢ Response status: ${response.status}`);
                
                const result = await response.json();
                log(`üü¢ Response: ${JSON.stringify(result)}`);
                
                if (result.success) {
                    log(`‚úÖ SUCCESS: ${actionType} action approved!`);
                    alert(`‚úÖ ${actionType} action approved and executed!`);
                } else {
                    log(`‚ùå ERROR: ${result.error || 'Failed to approve action'}`);
                    alert(`‚ùå Error: ${result.error || 'Failed to approve action'}`);
                }
            } catch (error) {
                log(`üî¥ Exception: ${error.message}`);
                alert(`üî¥ Error: ${error.message}`);
            }
        }

        async function rejectAction(resultId) {
            try {
                log(`üî¥ REJECT ACTION CALLED: ${resultId}`);
                
                const requestBody = {
                    resultId,
                    approved: false
                };
                
                log(`üî¥ Sending request: ${JSON.stringify(requestBody)}`);
                
                const response = await fetch('/api/test-comprehensive/approve', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestBody)
                });

                log(`üî¥ Response status: ${response.status}`);
                
                const result = await response.json();
                log(`üî¥ Response: ${JSON.stringify(result)}`);
                
                if (result.success) {
                    log(`‚úÖ SUCCESS: Action rejected!`);
                    alert(`‚úÖ Action rejected successfully!`);
                } else {
                    log(`‚ùå ERROR: ${result.error || 'Failed to reject action'}`);
                    alert(`‚ùå Error: ${result.error || 'Failed to reject action'}`);
                }
            } catch (error) {
                log(`üî¥ Exception: ${error.message}`);
                alert(`üî¥ Error: ${error.message}`);
            }
        }

        // Manual test functions
        async function testApprovalAPI() {
            log('üß™ Testing approval API directly...');
            await approveAction('manual-test-' + Date.now(), 'calendar');
        }

        async function createCalendarEvent() {
            try {
                log('üìÖ Creating calendar event...');
                
                const response = await fetch('/api/test-comprehensive/process', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        command: 'Schedule a dentist appointment for next Tuesday at 3 PM'
                    })
                });

                const result = await response.json();
                log(`üìÖ Calendar event created: ${JSON.stringify(result)}`);
                
                if (result.result && result.result.requiresApproval) {
                    log(`‚úÖ Event requires approval: ${result.id}`);
                    alert(`‚úÖ Calendar event created! ID: ${result.id}`);
                } else {
                    log(`‚ùå Event does not require approval`);
                    alert(`‚ùå Event created but doesn't require approval`);
                }
            } catch (error) {
                log(`üî¥ Error creating event: ${error.message}`);
                alert(`üî¥ Error: ${error.message}`);
            }
        }

        log('‚úÖ All event listeners set up');
    </script>
</body>
</html>
